"use strict";(()=>{var e={};e.id=8877,e.ids=[8877],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2846:(e,r,t)=>{t.r(r),t.d(r,{config:()=>c,default:()=>p,routeModule:()=>l});var s={};t.r(s),t.d(s,{default:()=>handler});var i=t(1802),n=t(7153),o=t(6249),a=t(298),u=t(5066);let d={PRO:{name:"Wersja PRO",price:15,features:["Nielimitowane darmowe ogłoszenia","Brak reklam na stronie","Statystyki wyświetleń ogłoszeń","Priorytetowe wsparcie techniczne","Wyr\xf3żniony status na profilu"],promotions:3,freePromotions:!0},PRO_PLUS:{name:"Wersja PRO+",price:25,features:["Wszystko z wersji PRO","Nielimitowane darmowe ogłoszenia","Nieograniczone darmowe promowanie ogłoszeń","Wyr\xf3żnione ramki wok\xf3ł ogłoszeń","Najwyższy priorytet w wynikach wyszukiwania","Dedykowane wsparcie techniczne"],promotions:-1,freePromotions:!0}};async function handler(e,r){if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});try{let t=e.cookies.token;if(!t)return r.status(401).json({error:"Token required"});let s=(0,a.W)(t);if(!s||!parseInt(s.id))return r.status(401).json({error:"Invalid token"});let{subscriptionType:i}=e.body;if(!i||!["PRO","PRO_PLUS"].includes(i))return r.status(400).json({error:"Invalid subscription type"});let n=await u.Z.user.findUnique({where:{id:parseInt(s.id)},include:{subscriptions:{where:{OR:[{status:"ACTIVE"},{status:"CANCELLED"}]},orderBy:{createdAt:"desc"},take:1}}});if(!n)return r.status(404).json({error:"User not found"});let o=new Date,p=n.subscriptionEnd&&n.subscriptionEnd>o,c=n.subscriptions[0],l=p&&c?.status==="ACTIVE";if(l)return r.status(400).json({error:"You already have an active subscription. Cancel it first or wait for it to expire."});d[i];let w=new Date,f=new Date(w);f.setMonth(f.getMonth()+1),c&&"CANCELLED"===c.status&&await u.Z.subscription.update({where:{id:c.id},data:{status:"EXPIRED",endDate:w}});let m=0;"PRO"===i?m=1:"PRO_PLUS"===i&&(m=3),await u.Z.user.update({where:{id:parseInt(s.id)},data:{subscriptionType:i,subscriptionStart:w,subscriptionEnd:f,promotionsUsed:0,promotionsLimit:m,subscriptionId:`sub_${Date.now()}_${parseInt(s.id)}`}}),await u.Z.subscription.create({data:{userId:parseInt(s.id),type:i,status:"ACTIVE",startDate:w,endDate:f,autoRenew:!0,paymentId:`pay_${Date.now()}_${parseInt(s.id)}`}}),r.status(200).json({success:!0,message:"Subscription purchased successfully",subscription:{type:i,startDate:w,endDate:f,promotionsLimit:m}})}catch(e){console.error("Purchase subscription error:",e),r.status(500).json({error:"Internal server error"})}}let p=(0,o.l)(s,"default"),c=(0,o.l)(s,"config"),l=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/subscriptions/purchase",pathname:"/api/subscriptions/purchase",bundlePath:"",filename:""},userland:s})},298:(e,r,t)=>{t.d(r,{W:()=>verifyToken,f:()=>signToken});var s=t(9344),i=t.n(s);let n=process.env.JWT_SECRET;if(!n)throw Error("JWT_SECRET is missing in environment variables");function signToken(e,r="7d"){let t={expiresIn:String(r)};return i().sign(e,n,t)}function verifyToken(e){return i().verify(e,n)}},5066:(e,r,t)=>{t.d(r,{Z:()=>n});var s=t(3524);let i=new s.PrismaClient,n=i}};var r=require("../../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[4222],()=>__webpack_exec__(2846));module.exports=t})();