"use strict";(()=>{var e={};e.id=7618,e.ids=[7618],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8289:(e,o,r)=>{r.r(o),r.d(o,{config:()=>p,default:()=>d,routeModule:()=>l});var t={};r.r(t),r.d(t,{default:()=>handler});var s=r(1802),n=r(7153),i=r(6249),a=r(298),u=r(5066);async function handler(e,o){if("POST"!==e.method)return o.status(405).json({error:"Method not allowed"});try{let r=e.cookies.token;if(console.log("\uD83D\uDE80 Promote API called:",{hasToken:!!r}),!r)return o.status(401).json({error:"Token required"});let t=(0,a.W)(r);if(!t||!parseInt(t.id))return o.status(401).json({error:"Invalid token"});console.log("\uD83D\uDC64 User decoded:",t.email);let{offerId:s}=e.body;if(!s)return o.status(400).json({error:"Offer ID is required"});console.log("\uD83D\uDCCB Promoting offer:",s);let n=await u.Z.user.findUnique({where:{id:parseInt(t.id)}});if(!n)return o.status(404).json({error:"User not found"});console.log("\uD83D\uDC64 User found:",{id:n.id,email:n.email,subscriptionType:n.subscriptionType,subscriptionEnd:n.subscriptionEnd,promotionsUsed:n.promotionsUsed});let i=new Date,d=n.subscriptionEnd&&n.subscriptionEnd>i;if(d){if("PRO_PLUS"===n.subscriptionType){if(n.promotionsUsed>=3)return o.status(403).json({error:"Wykorzystałeś już wszystkie promocje PRO+ w tym miesiącu (3/3)"})}else if("PRO"===n.subscriptionType&&n.promotionsUsed>=1)return o.status(403).json({error:"Wykorzystałeś już wszystkie promocje PRO w tym miesiącu (1/1)"})}let p=await u.Z.offer.findUnique({where:{id:parseInt(s)}});if(!p)return o.status(404).json({error:"Offer not found"});if(p.ownerId!==parseInt(t.id))return o.status(403).json({error:"You can only promote your own offers"});if(p.promoted&&p.promotedUntil&&p.promotedUntil>i)return o.status(400).json({error:"Offer is already promoted"});p.promoted&&p.promotedUntil&&p.promotedUntil<=i&&await u.Z.offer.update({where:{id:parseInt(s)},data:{promoted:!1,promotedUntil:null}});let l=new Date;if(l.setDate(l.getDate()+7),await u.Z.offer.update({where:{id:parseInt(s)},data:{promoted:!0,promotedUntil:l}}),d){if(console.log("\uD83D\uDD04 Updating promotions counter for:",n.subscriptionType),"PRO"===n.subscriptionType)console.log("\uD83D\uDCCA PRO: Incrementing from",n.promotionsUsed,"to",n.promotionsUsed+1),await u.Z.user.update({where:{id:parseInt(t.id)},data:{promotionsUsed:n.promotionsUsed+1}});else if("PRO_PLUS"===n.subscriptionType){console.log("⭐ PRO_PLUS: Incrementing from",n.promotionsUsed,"to",n.promotionsUsed+1);let e=await u.Z.user.update({where:{id:parseInt(t.id)},data:{promotionsUsed:n.promotionsUsed+1}});console.log("✅ PRO_PLUS: Updated successfully, new value:",e.promotionsUsed)}}else console.log("❌ No active subscription, skipping promotions counter update");await u.Z.promotionUsage.create({data:{userId:parseInt(t.id),offerId:parseInt(s)}});let f=0;d&&("PRO_PLUS"===n.subscriptionType?f=Math.max(0,3-(n.promotionsUsed+1)):"PRO"===n.subscriptionType&&(f=Math.max(0,1-(n.promotionsUsed+1)))),o.status(200).json({success:!0,message:"Offer promoted successfully",promotedUntil:l,promotionsRemaining:f,paymentProcessed:!d})}catch(e){console.error("Promote offer error:",e),o.status(500).json({error:"Internal server error"})}}let d=(0,i.l)(t,"default"),p=(0,i.l)(t,"config"),l=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/offers/promote",pathname:"/api/offers/promote",bundlePath:"",filename:""},userland:t})},298:(e,o,r)=>{r.d(o,{W:()=>verifyToken,f:()=>signToken});var t=r(9344),s=r.n(t);let n=process.env.JWT_SECRET;if(!n)throw Error("JWT_SECRET is missing in environment variables");function signToken(e,o="7d"){let r={expiresIn:String(o)};return s().sign(e,n,r)}function verifyToken(e){return s().verify(e,n)}},5066:(e,o,r)=>{r.d(o,{Z:()=>n});var t=r(3524);let s=new t.PrismaClient,n=s}};var o=require("../../../webpack-api-runtime.js");o.C(e);var __webpack_exec__=e=>o(o.s=e),r=o.X(0,[4222],()=>__webpack_exec__(8289));module.exports=r})();