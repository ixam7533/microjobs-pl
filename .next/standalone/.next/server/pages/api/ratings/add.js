"use strict";(()=>{var e={};e.id=4507,e.ids=[4507],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3168:(e,n,r)=>{r.r(n),r.d(n,{config:()=>u,default:()=>l,routeModule:()=>c});var t={};r.r(t),r.d(t,{default:()=>handler});var a=r(1802),o=r(7153),i=r(6249),s=r(5066),d=r(298);async function handler(e,n){if("POST"!==e.method)return n.status(405).json({message:"Method not allowed"});try{console.log("Rating API called with body:",e.body);let r=e.headers.authorization?.replace("Bearer ","")||e.cookies.token;if(console.log("Token found:",!!r),console.log("Token source:",e.headers.authorization?"header":"cookie"),console.log("Token length:",r?.length),console.log("Token first 20 chars:",r?.substring(0,20)),!r)return n.status(401).json({message:"Nie jesteś zalogowany"});let t=(0,d.W)(r);if(console.log("Token decoded successfully:",!!t),!t)return n.status(401).json({message:"Nieprawidłowy token"});let{reviewedEmail:a,rating:o,comment:i,offerId:l}=e.body;if(console.log("Request data:",{reviewedEmail:a,rating:o,comment:i,offerId:l}),!a||!o||o<1||o>5)return n.status(400).json({message:"Nieprawidłowe dane"});let u=await s.Z.user.findUnique({where:{email:t.email}}),c=await s.Z.user.findUnique({where:{email:a}});if(!u||!c)return n.status(404).json({message:"Użytkownik nie znaleziony"});if(u.id===c.id)return n.status(400).json({message:"Nie możesz ocenić samego siebie"});let g=await s.Z.rating.findFirst({where:{reviewerId:u.id,reviewedId:c.id,offerId:l||null}});if(g)return n.status(400).json({message:"Już oceniłeś tego użytkownika dla tej oferty"});console.log("Creating rating with data:",{rating:parseInt(o),comment:i||null,reviewerId:u.id,reviewedId:c.id,offerId:l||null});let f=await s.Z.rating.create({data:{rating:parseInt(o),comment:i||null,reviewerId:u.id,reviewedId:c.id,offerId:l||null},include:{reviewer:{select:{email:!0}}}});console.log("Rating created successfully:",f),n.status(201).json({message:"Ocena została dodana",rating:f})}catch(e){console.error("Błąd dodawania oceny:",e),console.error("Stack trace:",e.stack),n.status(500).json({message:"Wewnętrzny błąd serwera",error:void 0})}}let l=(0,i.l)(t,"default"),u=(0,i.l)(t,"config"),c=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/ratings/add",pathname:"/api/ratings/add",bundlePath:"",filename:""},userland:t})},298:(e,n,r)=>{r.d(n,{W:()=>verifyToken,f:()=>signToken});var t=r(9344),a=r.n(t);let o=process.env.JWT_SECRET;if(!o)throw Error("JWT_SECRET is missing in environment variables");function signToken(e,n="7d"){let r={expiresIn:String(n)};return a().sign(e,o,r)}function verifyToken(e){return a().verify(e,o)}},5066:(e,n,r)=>{r.d(n,{Z:()=>o});var t=r(3524);let a=new t.PrismaClient,o=a}};var n=require("../../../webpack-api-runtime.js");n.C(e);var __webpack_exec__=e=>n(n.s=e),r=n.X(0,[4222],()=>__webpack_exec__(3168));module.exports=r})();