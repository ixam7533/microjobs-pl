"use strict";(()=>{var e={};e.id=1637,e.ids=[1637],e.modules={3524:e=>{e.exports=require("@prisma/client")},4802:e=>{e.exports=require("cookie")},9344:e=>{e.exports=require("jsonwebtoken")},614:e=>{e.exports=require("next-auth/jwt")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2166:(e,t,r)=>{r.r(t),r.d(t,{config:()=>d,default:()=>c,routeModule:()=>h});var o={};r.r(o),r.d(o,{default:()=>handler});var a=r(1802),i=r(7153),s=r(6249),n=r(5066),u=r(5613),l=r(298);async function handler(e,t){if(console.log("\uD83D\uDE80 Chat API called:",e.method),"POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let r=await (0,u.A)(e);if(console.log("\uD83D\uDD0D getUserFromRequest result:",!!r),!r){let o=e.headers.authorization;if(console.log("\uD83D\uDD0D Authorization header:",!!o),o&&o.startsWith("Bearer ")){let e=o.substring(7);console.log("\uD83D\uDD0D Token from header:",!!e);try{r=(0,l.W)(e),console.log("✅ Token verified:",r?.email)}catch(e){return console.log("❌ Token verification failed:",e),t.status(401).json({error:"Invalid token"})}}}let{withEmail:o,offerId:a}=e.body;if(console.log("\uD83D\uDCE8 Chat request:",{userAuth:r?.email,withEmail:o,offerId:a}),!r)return console.log("❌ No user auth - returning 401"),t.status(401).json({error:"Unauthorized"});if(!o)return console.log("❌ Missing withEmail - returning 400"),t.status(400).json({error:"Missing withEmail"});let i=await n.Z.user.findUnique({where:{email:r.email}}),s=await n.Z.user.findUnique({where:{email:o}});if(console.log("\uD83D\uDD0D Chat participants:"),console.log("  - You (logged user):",r.email,"-> found:",!!i),console.log("  - Other (offer owner):",o,"-> found:",!!s),!s){console.log("\uD83D\uDD27 Creating basic user for chat participant:",o);try{s=await n.Z.user.create({data:{email:o,name:o.split("@")[0],confirmed:!1,subscriptionType:null,subscriptionStart:null,subscriptionEnd:null,promotionsUsed:0,promotionsLimit:0}}),console.log("✅ Basic user created for chat:",s.email)}catch(e){return console.error("❌ Failed to create basic user:",e),t.status(500).json({error:"Failed to create chat participant"})}}if(!i||!s)return console.log("❌ User(s) not found - you:",!!i,"other:",!!s),t.status(404).json({error:"User(s) not found"});let c=await n.Z.chat.findFirst({where:{participants:{some:{userId:i.id}},AND:{participants:{some:{userId:s.id}}}}});return c||(c=await n.Z.chat.create({data:{participants:{create:[{userId:i.id},{userId:s.id}]}}})),t.status(201).json({chatId:c.id})}let c=(0,s.l)(o,"default"),d=(0,s.l)(o,"config"),h=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/auth/chats/new",pathname:"/api/auth/chats/new",bundlePath:"",filename:""},userland:o})}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[4222,5613],()=>__webpack_exec__(2166));module.exports=r})();