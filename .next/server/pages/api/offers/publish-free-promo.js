"use strict";(()=>{var e={};e.id=9257,e.ids=[9257],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},614:e=>{e.exports=require("next-auth/jwt")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3374:(e,o,s)=>{s.r(o),s.d(o,{config:()=>l,default:()=>p,routeModule:()=>m});var r={};s.r(r),s.d(r,{default:()=>handler});var t=s(1802),i=s(7153),n=s(6249),a=s(3524),u=s(298),c=s(614);let d=new a.PrismaClient;async function handler(e,o){if("POST"!==e.method)return o.status(405).json({success:!1,error:"Method not allowed"});try{let s=null,r=await (0,c.getToken)({req:e,secret:process.env.NEXTAUTH_SECRET});if(r&&r.email){let e=await d.user.findUnique({where:{email:r.email},select:{id:!0}});e&&(s=e.id)}if(!s){let r=e.cookies.token;if(!r)return o.status(401).json({success:!1,error:"Not authenticated"});let t=(0,u.W)(r);if(!t||"string"==typeof t||!t.id)return o.status(401).json({success:!1,error:"Invalid token"});s=t.id}if(!s)return o.status(401).json({success:!1,error:"User not found"});let{offerType:t,title:i,description:n,price:a,category:p,location:l,contactName:m,contactEmail:f,contactPhone:w}=e.body,j=await d.user.findUnique({where:{id:s},select:{id:!0,email:!0,subscriptionType:!0,subscriptionEnd:!0,promotionsUsed:!0}});if(!j)return o.status(404).json({success:!1,error:"User not found"});let b=new Date,k=j.subscriptionEnd&&j.subscriptionEnd>b;if(!k||"PRO_PLUS"!==j.subscriptionType&&"PRO"!==j.subscriptionType)return o.status(403).json({success:!1,error:"Tylko użytkownicy PRO i PRO+ mogą korzystać z darmowych promocji"});let y=0;if("PRO_PLUS"===j.subscriptionType?y=3:"PRO"===j.subscriptionType&&(y=1),j.promotionsUsed>=y)return o.status(403).json({success:!1,error:`Wykorzystałeś już wszystkie promocje ${j.subscriptionType} w tym miesiącu (${y}/${y})`});console.log("Publikuję darmowe ogłoszenie + promocja:",j.subscriptionType,{title:i,category:p,location:l,userEmail:j.email,currentPromotionsUsed:j.promotionsUsed});let P=await d.offer.create({data:{offerType:t,title:i,description:n,price:parseFloat(a)||0,category:p,location:l,contactName:m,contactEmail:f,contactPhone:w||"",promoted:!0,promotedUntil:new Date(Date.now()+6048e5),ownerId:s,createdAt:new Date,updatedAt:new Date}});await d.user.update({where:{id:s},data:{promotionsUsed:j.promotionsUsed+1}}),console.log("Ogłoszenie + promocja PRO+ opublikowane:",{offerId:P.id,newPromotionsUsed:j.promotionsUsed+1,promotionsRemaining:Math.max(0,3-(j.promotionsUsed+1))});let T=Math.max(0,3-(j.promotionsUsed+1));o.status(200).json({success:!0,offerId:P.id,promotionsRemaining:T,message:`Ogłoszenie z promocją opublikowane. Pozostało promocji PRO+: ${T}/3`})}catch(e){console.error("Błąd publikacji darmowej promocji:",e),o.status(500).json({success:!1,error:"Błąd serwera podczas publikacji"})}}let p=(0,n.l)(r,"default"),l=(0,n.l)(r,"config"),m=new t.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/offers/publish-free-promo",pathname:"/api/offers/publish-free-promo",bundlePath:"",filename:""},userland:r})},298:(e,o,s)=>{s.d(o,{W:()=>verifyToken,f:()=>signToken});var r=s(9344),t=s.n(r);let i=process.env.JWT_SECRET;if(!i)throw Error("JWT_SECRET is missing in environment variables");function signToken(e,o="7d"){let s={expiresIn:String(o)};return t().sign(e,i,s)}function verifyToken(e){return t().verify(e,i)}}};var o=require("../../../webpack-api-runtime.js");o.C(e);var __webpack_exec__=e=>o(o.s=e),s=o.X(0,[4222],()=>__webpack_exec__(3374));module.exports=s})();