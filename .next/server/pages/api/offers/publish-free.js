"use strict";(()=>{var e={};e.id=8859,e.ids=[8859],e.modules={3524:e=>{e.exports=require("@prisma/client")},9344:e=>{e.exports=require("jsonwebtoken")},614:e=>{e.exports=require("next-auth/jwt")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3438:(e,r,s)=>{s.r(r),s.d(r,{config:()=>f,default:()=>d,routeModule:()=>p});var t={};s.r(t),s.d(t,{default:()=>handler});var o=s(1802),n=s(7153),i=s(6249),a=s(3524),u=s(298),l=s(614);let c=new a.PrismaClient;async function handler(e,r){if("POST"!==e.method)return r.status(405).json({success:!1,error:"Method not allowed"});try{let s=null,t=await (0,l.getToken)({req:e,secret:process.env.NEXTAUTH_SECRET});if(t&&t.email){let e=await c.user.findUnique({where:{email:t.email},select:{id:!0}});e&&(s=e.id)}if(!s){let t=e.cookies.token;if(!t)return r.status(401).json({success:!1,error:"Not authenticated"});let o=(0,u.W)(t);if(!o||"string"==typeof o||!o.id)return r.status(401).json({success:!1,error:"Invalid token"});s=o.id}if(!s)return r.status(401).json({success:!1,error:"User not found"});let o=await c.user.findUnique({where:{id:s},select:{subscriptionType:!0,subscriptionEnd:!0,offers:{select:{id:!0}}}});if(!o)return r.status(404).json({success:!1,error:"User not found"});let n=o.subscriptionEnd&&o.subscriptionEnd>new Date,i=n&&("PRO"===o.subscriptionType||"PRO_PLUS"===o.subscriptionType),a=0===o.offers.length;if(console.log("\uD83D\uDD0D Free publish check:",{hasProSubscription:i,isFirstOffer:a,offerCount:o.offers.length}),!i&&!a)return r.status(403).json({success:!1,error:"Darmowa publikacja dostępna tylko dla użytkownik\xf3w PRO/PRO+ lub jako pierwsza oferta"});let{offerType:d,title:f,description:p,price:w,category:k,location:b,contactName:g,contactEmail:m,contactPhone:h}=e.body,j=a?"pierwsza oferta":"PRO/PRO+";console.log(`Publikuję darmowe ogłoszenie (${j}):`,{title:f,category:k,location:b});let P=await c.offer.create({data:{offerType:d,title:f,description:p,price:parseFloat(w)||0,category:k,location:b,contactName:g,contactEmail:m,contactPhone:h||"",promoted:!1,ownerId:s,createdAt:new Date,updatedAt:new Date}});console.log("Ogłoszenie PRO opublikowane:",P.id),r.status(200).json({success:!0,offerId:P.id,message:`Ogłoszenie opublikowane za darmo (${j})`})}catch(e){console.error("Błąd publikacji darmowej:",e),r.status(500).json({success:!1,error:"Błąd serwera podczas publikacji"})}}let d=(0,i.l)(t,"default"),f=(0,i.l)(t,"config"),p=new o.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/offers/publish-free",pathname:"/api/offers/publish-free",bundlePath:"",filename:""},userland:t})},298:(e,r,s)=>{s.d(r,{W:()=>verifyToken,f:()=>signToken});var t=s(9344),o=s.n(t);let n=process.env.JWT_SECRET;if(!n)throw Error("JWT_SECRET is missing in environment variables");function signToken(e,r="7d"){let s={expiresIn:String(r)};return o().sign(e,n,s)}function verifyToken(e){return o().verify(e,n)}}};var r=require("../../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),s=r.X(0,[4222],()=>__webpack_exec__(3438));module.exports=s})();